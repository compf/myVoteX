<html>

<head>
    <title>Privacy</title>
</head>

<body>


    <script>
    const publicKey = "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA3sGFik6GMYMQLFDKvk/Yhl4a96Gi3BifvgjJDB6voUKdWoIdMX/JMEcEFu25msixuRt6x0P3xk8YJn9RKa1OpREXNhX/3+LGzhJJGC6u2sk5g2pwEdXBx2UnOsRgbh2b/1naxqgO+dsW26KK7DNMjSjGkvTLHVYAJK8Sn+lQbkodMHGeft14UFaXvMJ/fc3KCtcInfchkbRRx8yWEqOhQyvQqhuzNhGCgaUk70pE150mozBEMpMUtBN+WzVn1ReCGyuzpoXyDn6p3QP8H0yQfvS75LmpFINurMhKnFFzJk63Yauhw9Alp7nI1CXt0IURgUQOALWjEGF6j7ci+GksLwIDAQAB"



        let text = "Hello, world! cdsacs";
        function str2ab(str) {
            const buf = new ArrayBuffer(str.length);
            const bufView = new Uint8Array(buf);
            for (let i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        }

       async  function importRsaKey(pem) {

            let pemContents = pem.replace(/-----BEGIN PUBLIC KEY-----|-----END PUBLIC KEY-----|\n/g, '');
            console.log("\"", pemContents, "\"");
            // base64 decode the string to get the binary data
            const binaryDerString = window.atob(pemContents);
            // convert from a binary string to an ArrayBuffer
            const binaryDer = str2ab(binaryDerString);

            return await window.crypto.subtle.importKey(
                "spki",
                binaryDer,
                {
                    name: "RSA-OAEP",
                    hash: "SHA-256",
                },
                true,
                ["encrypt", "wrapKey"],
            );
        }



   

        async function encrypt(text) {
            let aesKey = await window.crypto.subtle.generateKey({
                name: "AES-GCM",
                length: 256
            }, true, ["encrypt", "decrypt", "wrapKey", "unwrapKey"]);


            let rsaKey = await importRsaKey(publicKey);

            let encryptedKey = await window.crypto.subtle.wrapKey("raw", aesKey, rsaKey, "RSA-OAEP");

            let iv = window.crypto.getRandomValues(new Uint8Array(12));
            let encrypted = await window.crypto.subtle.encrypt({
                name: "AES-GCM",
                iv: iv,
            }, aesKey, new TextEncoder().encode(text));
            return {
                wrappedKey: encryptedKey,
                encrypted: encrypted,
                iv: iv
            }
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            let bytes = new Uint8Array(buffer);
            let len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        async function importPrivateKey(pem) {
            // fetch the part of the PEM string between header and footer
            const pemHeader = "-----BEGIN PRIVATE KEY-----";
            const pemFooter = "-----END PRIVATE KEY-----";
            const pemContents = pem.substring(
                pemHeader.length,
                pem.length - pemFooter.length - 1,
            );
            // base64 decode the string to get the binary data
            const binaryDerString = window.atob(pemContents);
            // convert from a binary string to an ArrayBuffer
            const binaryDer = str2ab(binaryDerString);

            return await  window.crypto.subtle.importKey(
                "pkcs8",
                binaryDer,
                {
                    name: "RSA-OAEP",
                    hash: "SHA-256",
                },
                true,
                ["decrypt", "unwrapKey"],
            );
        }

        async function decrypt(wrappedKey, encrypted, iv) {

            let privateKey = await importPrivateKey(privateKeyPKS);

            let unwrappedKey = await window.crypto.subtle.unwrapKey(
                "raw",
                wrappedKey,
                privateKey,
                {
                    name: "RSA-OAEP",
                    hash: "SHA-256"
                },
                {
                    name: "AES-GCM",
                    length: 256
                },
                true,
                ["encrypt", "decrypt"]
            );

            let decrypted = await window.crypto.subtle.decrypt({
                name: "AES-GCM",
                iv: iv,
            }, unwrappedKey, encrypted);

            return new TextDecoder().decode(decrypted);

        }

        encrypt(text).then((x) => {
            console.log(text)
            console.log()

            console.log(x)
            console.log(arrayBufferToBase64(privateKeyPKS))
            console.log()
            console.log(arrayBufferToBase64(x.encrypted))
            console.log()
            console.log(arrayBufferToBase64(x.wrappedKey))
            console.log()
            console.log(arrayBufferToBase64(x.iv))
            decrypt(x.wrappedKey, x.encrypted, x.iv).then((decrypted) => {
                console.log();
                console.log(decrypted);
            });

        });
    </script>
</body>


</html>